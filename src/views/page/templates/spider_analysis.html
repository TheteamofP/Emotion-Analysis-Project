<!DOCTYPE HTML>
<html>
<head>
    <title>爬虫分析</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <noscript><link rel="stylesheet" href="/static/css/noscript.css" /></noscript>
</head>
<body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">

        <header id="header">
            <div class="logo">
                <span class="icon fa-gem"></span>
            </div>
            <div class="content">
                <div class="inner">
                    <h1>爬虫分析</h1>
                    <p>输入链接进行用户或话题分析</p>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="#user_analysis">用户分析</a></li>
                    <li><a href="#topic_analysis">话题分析</a></li>
                    <li><a href="{{ url_for('home') }}">返回主页</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main -->
        <div id="main">
            <article id="user_analysis">
                <h2 class="major">用户分析</h2>
                <form id="userAnalysisForm" method="post">
                    <div class="fields">
                        <div class="field">
                            <label for="user_url">用户主页链接</label>
                            <input type="text" id="user_url" name="url"required>
                            <div class="url-preview-container">
                                <span class="preview-label">URL 预览</span>
                                <div id="user_url_preview" class="url-preview empty">等待输入...</div>
                                <div id="user_url_validation" class="validation-message"></div>
                            </div>
                        </div>
                    </div>
                    <ul class="actions">
                        <li><button type="submit" id="user_submit" disabled >开始分析</button></li>
                    </ul>
                </form>
                <div id="user_result"></div>
            </article>

            <article id="topic_analysis">
                <h2 class="major">话题分析</h2>
                <form id="topicAnalysisForm" method="post">
                    <div class="fields">
                        <div class="field">
                            <label for="topic_url">话题链接</label>
                            <input type="text" id="topic_url" name="url" required>
                            <div class="url-preview-container">
                                <span class="preview-label">URL 预览</span>
                                <div id="topic_url_preview" class="url-preview empty">等待输入...</div>
                                <div id="topic_url_validation" class="validation-message"></div>
                            </div>
                        </div>
                    </div>
                    <ul class="actions">
                        <li><button type="submit" id="topic_submit" disabled>开始分析</button></li>
                    </ul>
                </form>
                <div id="topic_result"></div>
            </article>
        </div>

        <!-- Footer -->
        <footer id="footer">
            <p class="copyright">&copy; 2024 情感分析系统</p>
        </footer>
    </div>

    <!-- BG -->
    <div id="bg"></div>

    <!-- Scripts -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/browser.min.js"></script>
    <script src="/static/js/breakpoints.min.js"></script>
    <script src="/static/js/util.js"></script>
    <script src="/static/js/main.js"></script>

    <!-- AJAX Scripts -->
    <script>
        function validateUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch (e) {
                return false;
            }
        }

        function setupUrlValidation(inputId, previewId, validationId, submitButtonId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const validation = document.getElementById(validationId);
            const submitButton = document.getElementById(submitButtonId);

            let timeoutId;

            input.addEventListener('input', function() {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    const url = this.value.trim();

                    if (url === '') {
                        preview.textContent = '等待输入...';
                        preview.className = 'url-preview empty';
                        validation.className = 'validation-message';
                        validation.textContent = '';
                        submitButton.disabled = true;
                        return;
                    }

                    preview.textContent = url;
                    preview.className = 'url-preview';

                    const isValid = validateUrl(url);
                    preview.className = 'url-preview ' + (isValid ? 'valid' : 'invalid');
                    validation.className = 'validation-message ' + (isValid ? 'valid' : 'invalid');
                    validation.textContent = isValid ? 'URL格式正确' : 'URL格式不正确';
                    submitButton.disabled = !isValid;
                }, 300);
            });
        }

        $(document).ready(function() {
            // 设置URL验证
            setupUrlValidation('user_url', 'user_url_preview', 'user_url_validation', 'user_submit');
            setupUrlValidation('topic_url', 'topic_url_preview', 'topic_url_validation', 'topic_submit');

            // 用户分析 AJAX 请求
            $('#userAnalysisForm').on('submit', function(event) {
                event.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("page.spider_analysis_user") }}',
                    data: formData,
                    success: function(response) {
                        console.log("用户分析返回的数据：", response); // 检查返回的数据
                        if(response.error) {
                            $('#user_result').html('<h3 class="error">' + response.error + '</h3>');
                        } else {
                            // 构建并显示用户分析结果
                            let resultHTML = '<h3>用户分析结果:</h3>';
                            resultHTML += '<div class="result-content">';
                            resultHTML += '<p>分析链接: ' + response.result.url + '</p>';
                            resultHTML += '<p>发帖数量: ' + response.result.post_count + '</p>';
                            resultHTML += '<p>互动数量: ' + response.result.interaction_count + '</p>';
                            resultHTML += '<p>活跃度评分: ' + response.result.activity_score + '</p>';
                            resultHTML += '</div>';
                            $('#user_result').html(resultHTML);
                        }
                    },
                    error: function(xhr) {
                        $('#user_result').html('<h3 class="error">分析失败，请重试</h3>');
                    }
                });
            });


            $('#topicAnalysisForm').on('submit', function(event) {
                event.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("page.spider_analysis_topic") }}',
                    data: formData,
                    success: function(response) {
                        console.log("话题分析返回的数据：", response);
                        if(response.error) {
                            $('#topic_result').html('<h3 class="error">' + response.error + '</h3>');
                        } else {
                            // 构建并显示话题分析结果
                            let resultHTML = '<h3>话题分析结果:</h3>';
                            resultHTML += '<div class="result-content">';
                            resultHTML += '<p>分析链接: ' + response.result.url + '</p>';
                            resultHTML += '<p>讨论数量: ' + response.result.discussion_count + '</p>';
                            resultHTML += '<p>参与人数: ' + response.result.participant_count + '</p>';
                            resultHTML += '<p>话题热度: ' + response.result.popularity_score + '</p>';
                            resultHTML += '<p>情感倾向: ' + response.result.sentiment + '</p>';
                            resultHTML += '</div>';

                            // 在结果HTML中添加按钮
                            resultHTML += '<button id="gpt_suggest" style="display:block;">点击查看AI助手建议</button>';
                            $('#topic_result').html(resultHTML);

                            // 为新添加的按钮绑定点击事件处理函数
                           $('#gpt_suggest').on('click', function() {
                                // 获取纯文本的分析结果，而非 HTML 格式
                                var resultText = $('#topic_result .result-content').text(); // 仅提取文字内容
                                var suggestionText = "话题分析结果：\n" + resultText + "\n请对此进行分析和建议";
                                window.location.href = '{{ url_for("home") }}?text=' + encodeURIComponent(suggestionText) + '#gpt_suggestion';
                            });
                        }
                    },
                    error: function(xhr) {
                        $('#topic_result').html('<h3 class="error">分析失败，请重试</h3>');
                    }
                });
            });
        });
    </script>
</body>
</html>